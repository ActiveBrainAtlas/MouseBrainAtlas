# Software installation

`$ pip install activeatlas`

This will download the scripts and the package containing the reference anatomical model and the trained texture classifiers.

Edit `global_setting.py`. In particular, specify the following variables:
- `DATA_DIR`
- `REPO_DIR`

#


# File organization #

Every image generated by the pipeline can be uniquely identified by the following information:
- image name: See below.
- version: a word that specifies a channel or the processed result of a particular channel. For example, it can be "Ntb" for neurotrace channel, "CHAT" for the ChAT channel, "NtbNormalized" for the intensity-normalized neurotrace channel.
- resolution: a word that specifies the pixel resolution. It can be "raw", "down32" (downsample raw data in both dimensions by a factor of 32), "thumbnail" (same as "down32"). It can also be an absolute physical size such as "10.0um".
- prep id: a number or word that identifies the preprocessing procedure applied, such as rotation and cropping.

### Image Name ###

Each physical section is associated with an `imageName`.
There is no fixed composition rule for image names.
The principle is that one can trace back from an image name to the physical section. Therefore in each image name, these two elements are mandatory:
- slide number
- section or scene index in the slide

Other than that, the brain id is optional but desired. Other information such as the scan date or stain name are optional.
For example, both `CHATM3_slide31_2018_02_17-S2` and `Slide31-Nissl-S2` are valid image names.
It is important to use only one composition rule for each brain. Do not use space or special characters.



## Visualize and revise annotations using the labeling GUI

Download warped atlas maps into `VOLUME_DIR/<atlasName>/<atlasName>_<warp>_<fixedMapName>`.

Click "Load warped structures". Select structure. The structure contour (p=0.5) will be displayed over the images. You can move or rotate with respect to structure center. Each structure is manipulated as one integral 3-D entity. For complete instructions on how to interact with GUI, see [User Interface README](../gui/README.md).

Click "Save prob. structures". All structures currently loaded are saved into the file `ANNOTATION_DIR/<stack>/<stack>_annotation_probStructures_<timestamp>.hdf`.

Each row of the structure annotation file is indexed by a random `structure_id`. The columns are

* `volume_in_bbox`: bloscpack-encoded string of 3-D volume, isotropic voxel size ~ 0.45 micron * 32 = 14.4 micron.
* `bbox`: (xmin,xmax,ymin,ymax,zmin,zmax), wrt "wholebrain", same voxel size as above.
* `name`: structure name, unsided
* `side`: L or R or S
* `edits`. list. Each entry is a dict.
	* `username`
	* `timestamp`
	* `type`: shift3d or rotate3d
	* `transform`: flattened 3x4 matrix
	* `centroid_m`
	* `centroid_f`


